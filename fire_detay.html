<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fire Detay</title>
<style>
body { background:#1a1a1a; color:white; font-family:Arial,sans-serif; margin:10px; }
h2 { text-align:center; }
input, button { padding:6px; margin:6px 0; border-radius:4px; border:none; }
button { cursor:pointer; background:#000; color:white; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
th, td { border:1px solid #555; padding:6px; text-align:center; vertical-align:middle; }
th { background:#333; }
.kod-ad { display:flex; flex-direction:column; font-weight:bold; }
.tutar { font-weight:bold; }
.islem-btns { display:flex; flex-direction:column; gap:4px; justify-content:center; }
.islem-btns button { width:100%; padding:4px 8px; }
.gecmis-row { display:none; background:#222; }
.adet { color:lime; font-weight:bold; }
.gram { color:yellow; font-weight:bold; }
.tutar500 { color:red; font-weight:bold; }
tfoot td { padding:6px; font-weight:bold; text-align:left; }
</style>
</head>
<body>
<h2>Fire Detay</h2>

<div style="display:flex; gap:10px; flex-wrap:wrap;">
  <input type="date" id="baslangic">
  <input type="date" id="bitis">
  <button onclick="filtrele()">Filtrele</button>
  <button onclick="temizleFiltre()">Tümünü Göster</button>
</div>

<table id="detayTablo">
<thead>
<tr><th>Kod / Ad</th><th>Miktar</th><th style="display:none;">Birim</th><th>Fiyat</th><th>%</th><th>Grup</th><th>Tutar</th><th>Tarih</th><th>İşlem</th></tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
  <td colspan="9">
    <div id="grupToplam" style="display:flex; flex-wrap:wrap; gap:20px; margin-bottom:6px;"></div>
    <div id="genelToplam" style="color:#ffff99; font-weight:bold; margin-bottom:6px;"></div>
    <div style="display:flex; align-items:center; gap:6px;">
      Ciro: <input type="number" id="ciro" style="width:100px;">
      <button onclick="hesaplaCiro()">Hesapla</button>
      <span id="ciroSonuc" style="color:#ff6666; font-weight:bold; margin-left:10px;"></span>
    </div>
  </td>
</tr>
</tfoot>
</table>

<script>
let genelToplam = 0;

function listele(filterBaslangic="", filterBitis=""){
  const tbody = document.querySelector("#detayTablo tbody");
  tbody.innerHTML = "";
  const fireDetay = JSON.parse(localStorage.getItem("fireDetay")||"[]");

  let grupToplam = {};
  genelToplam = 0;

  fireDetay.forEach((f,index)=>{
    // Ürünün geçmişini al
    let gecmisVar = f.gecmis && f.gecmis.length>0 ? f.gecmis : [{miktar: f.miktar, birim: f.birim, tarihSaat: f.tarihSaat}];

    // Filtre varsa sadece seçilen tarih aralığındaki geçmişleri al
    if(filterBaslangic || filterBitis){
      const bas = filterBaslangic ? new Date(filterBaslangic + "T00:00:00") : null;
      const bit = filterBitis ? new Date(filterBitis + "T23:59:59") : null;

      gecmisVar = gecmisVar.filter(g=>{
        const tarih = new Date(g.tarihSaat);
        if(bas && tarih < bas) return false;
        if(bit && tarih > bit) return false;
        return true;
      });

      if(gecmisVar.length === 0) return; // filtreye uymayan ürün tamamen gizlenir
    }

    // Filtrelenmiş tutar
    let toplamTutar = 0;
    gecmisVar.forEach(g=>{
      toplamTutar += parseFloat((f.fiyat * (g.birim==="adet"?g.miktar:g.miktar/1000) / (f.yuzde===1?1.01:f.yuzde===10?1.1:1.2)).toFixed(2));
    });

    // Grup toplamları
    if(!grupToplam[f.grup]) grupToplam[f.grup] = 0;
    grupToplam[f.grup] += toplamTutar;
    genelToplam += toplamTutar;

    // Ana satır
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="kod-ad">${f.kod}<br>${f.ad}</td>
                    <td>${gecmisVar.reduce((sum,g)=>sum+g.miktar,0)}</td>
                    <td style="display:none;">${f.birim}</td>
                    <td>${f.fiyat}</td>
                    <td>${f.yuzde}%</td>
                    <td>${f.grup}</td>
                    <td class="tutar ${toplamTutar>500?'tutar500':''}">${toplamTutar.toFixed(2)}</td>
                    <td>${gecmisVar.map(g=>g.tarihSaat).join(", ")}</td>
                    <td class="islem-btns">
                      <button onclick="toggleGecmis(${index})">+</button>
                      <button onclick="duzenle(${index})">Düzenle</button>
                      <button onclick="sil(${index})">Sil</button>
                    </td>`;
    tbody.appendChild(tr);

    // Geçmiş satırları
    gecmisVar.forEach((g,i)=>{
      const tr2 = document.createElement("tr");
      tr2.className="gecmis-row gecmis-"+index;
      const miktarClass = g.birim==="adet"?"adet":"gram";
      const tutarG = (f.fiyat * (g.birim==="adet"?g.miktar:g.miktar/1000) / (f.yuzde===1?1.01:f.yuzde===10?1.1:1.2)).toFixed(2);
      tr2.innerHTML = `<td colspan="1"></td>
                       <td class="${miktarClass}">${g.miktar}</td>
                       <td style="display:none;">${g.birim}</td>
                       <td>${f.fiyat}</td>
                       <td>${f.yuzde}%</td>
                       <td>${f.grup}</td>
                       <td class="tutar ${tutarG>500?'tutar500':''}">${tutarG}</td>
                       <td colspan="2">${g.tarihSaat}</td>`;
      tbody.appendChild(tr2);
    });
  });

  // Grup ve genel toplamlar
  const grupDiv = document.getElementById("grupToplam");
  grupDiv.innerHTML = "";
  for(let g in grupToplam){
    const span = document.createElement("span");
    span.style.fontWeight = "bold";
    span.textContent = `${g}: ${grupToplam[g].toFixed(2)} TL`;
    grupDiv.appendChild(span);
  }
  document.getElementById("genelToplam").textContent = `Genel Toplam: ${genelToplam.toFixed(2)} TL`;
}

function filtrele(){
  const bas = document.getElementById("baslangic").value;
  const bit = document.getElementById("bitis").value;
  listele(bas, bit);
}

function temizleFiltre(){
  document.getElementById("baslangic").value="";
  document.getElementById("bitis").value="";
  listele();
}

function toggleGecmis(index){
  const rows = document.querySelectorAll(".gecmis-"+index);
  rows.forEach(r=> r.style.display = r.style.display==="table-row"?"none":"table-row");
}

function hesaplaCiro(){
  const ciro = parseFloat(document.getElementById("ciro").value);
  if(!ciro || ciro===0){ alert("Ciroyu doğru giriniz."); return; }
  const sonuc = (genelToplam / ciro * 100).toFixed(2);
  document.getElementById("ciroSonuc").textContent = sonuc + " %";
}

function duzenle(index){
  let fireDetay = JSON.parse(localStorage.getItem("fireDetay")||"[]");
  const f = fireDetay[index];

  if(!f.gecmis) f.gecmis=[];
  f.gecmis.push({miktar:f.miktar, birim:f.birim, tarihSaat: new Date().toLocaleString()});

  const urunKod = prompt("Ürün Kodu:", f.kod);
  const urunAd = prompt("Ürün Adı:", f.ad);
  const miktar = parseFloat(prompt("Miktar:", f.miktar));
  const birim = prompt("Birim (adet/gram):", f.birim);
  const fiyat = parseFloat(prompt("Fiyat:", f.fiyat));
  const yuzde = parseInt(prompt("Yüzde (1/10/20):", f.yuzde));
  const grup = prompt("Grup:", f.grup);

  fireDetay[index]={kod:urunKod,ad:urunAd,miktar,birim,fiyat,yuzde,grup,gecmis:f.gecmis};
  localStorage.setItem("fireDetay", JSON.stringify(fireDetay));
  listele();
}

function sil(index){
  if(confirm("Bu ürünü ve geçmişi silmek istediğinize emin misiniz?")){
    let fireDetay = JSON.parse(localStorage.getItem("fireDetay")||"[]");
    fireDetay.splice(index,1);
    localStorage.setItem("fireDetay", JSON.stringify(fireDetay));
    listele();
  }
}

// Sayfa yüklendiğinde tüm ürünleri göster
listele();
</script>
</body>
</html>
